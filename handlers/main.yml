---
# handlers file for openio-sds

- name: "Restart meta0 meta1"
  changed_when: true
  debug:
      msg: "Restarting meta0 and meta1 on namespace {{openio_namespace}}"
  notify:
      - "Restart meta0 meta1: pid"
      - "Restart meta0 meta1: restart"
      - "Restart meta0 meta1: wait"
      - "Restart meta0 meta1: cleanup"

- name: "Restart meta0 meta1: pid"
  changed_when: true
  shell: "{{ openio_gridinit_cmd }} status2 @meta0 @meta1 | grep {{openio_namespace}} | awk '{print $3}'"
  register: m0m1_pid

- name: "Restart meta0 meta1: restart"
  shell: "{{ openio_gridinit_cmd }} restart $({{ openio_gridinit_cmd }} status @meta0 @meta1 |
          grep ' {{ openio_namespace }},' | awk '{print $1}')"

- name: "Restart meta0 meta1: wait"
  changed_when: true
  wait_for:
    path: "/proc/{{ item }}/status"
    state: absent
    timeout: 30
  with_items: "{{ m0m1_pid.stdout_lines }}"
  ignore_errors: yes
  register: m0m1_pid_killed

- name: "Restart meta0 meta1: cleanup"
  changed_when: true
  shell: "kill -9 {{ item }}"
  with_items: "{{ m0m1_pid_killed.results | select('failed') | map(attribute='item') | list }}"



- name: "Assign rdir"
  changed_when: true
  debug:
      msg: "Updating rdir assignment on {{openio_namespace}}"
  notify:
      - "Assign rdir: unlock"
      - "Assign rdir: assign"

- name: "Assign rdir: unlock"
  shell: "{{ openio_cli_path }} cluster unlockall --oio-ns={{ openio_namespace }} rawx rdir &&
          {{ openio_cli_path }} cluster wait      --oio-ns={{ openio_namespace }} rawx rdir"
  changed_when: true
  when: openio_bootstrap != 'True'

- name: "Assign rdir: assign"
  command: "{{ openio_cli_path }} --oio-ns={{ openio_namespace }} volume admin bootstrap"
  changed_when: true
  when:
      - inventory_hostname == groups['openio_conscience'][0]
...
